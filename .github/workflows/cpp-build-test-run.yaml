name: C++ build, test and run
on:
  workflow_call:
    inputs:
      homebrew-downloads-hash-from-prepare-macos:
        description: Hash of cached Homebrew downloads on MacOS
        required: true
        type: string
      homebrew-downloads-hash-from-prepare-ubuntu:
        description: Hash of cached Homebrew downloads on Ubuntu
        required: true
        type: string
  workflow_dispatch:
permissions:
  contents: read

jobs:
  build-test-run:
    strategy:
      fail-fast: false
      matrix:
        os:
          - macos
        compiler:
          - clang
          - gcc
        cxxLib:
          - libc++
          - libstdc++
        buildType:
          - debug
          - release
        exclude:
          - compiler: gcc
            cxxLib: libc++
        include:
          - os: macos
            homebrew-downloads-hash-from-prepare: ${{ inputs.homebrew-downloads-hash-from-prepare-macos }}
            runsOn: macos-15

          - os: ubuntu

            compiler: clang
            cxxLib: libstdc++
            buildType: release
            homebrew-downloads-hash-from-prepare: ${{ inputs.homebrew-downloads-hash-from-prepare-ubuntu }}
            runsOn: ubuntu-24.04

    name: ${{ matrix.os }} ${{ matrix.compiler }} ${{ matrix.cxxLib }} ${{ matrix.buildType }} - Build + test + run
    runs-on: ${{ matrix.runsOn }}
    timeout-minutes: 30

    steps:
      - name: Define workflow preset name
        id: preset-name
        run: |
          name="ci-${{ matrix.os }}-${{ matrix.compiler }}-${{ matrix.cxxLib }}-${{ matrix.buildType }}"
          echo "name=${name}" | tee -a "${GITHUB_OUTPUT}"
        shell: bash

      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          submodules: true

      - name: Setup homebrew packages
        uses: ./.github/actions/homebrew-packages-setup
        with:
          cache-mode: use
          downloads-hash-from-prepare: ${{ matrix.homebrew-downloads-hash-from-prepare }}

      - name: Setup tools through mise
        uses: ./.github/actions/mise-project-setup
        with:
          directory: solvers/cpp

      - id: setup-cmake-project
        name: Setup CMake project
        uses: ./.github/actions/cmake-project-setup
        with:
          conan-cache-key-prefix: conan-${{ steps.preset-name.outputs.name }}

      - if: matrix.os == 'ubuntu'
        name: Specify HOMEBREW_PREFIX
        run: |
          brewPrefix=$(brew --prefix)
          echo "HOMEBREW_PREFIX=${brewPrefix}" | tr -d '\n' >> "${GITHUB_ENV}"
        shell: bash

      - name: Run CMake workflow
        uses: lukka/run-cmake@af1be47fd7c933593f687731bc6fdbee024d3ff4 # v10.8
        with:
          cmakeListsTxtPath: solvers/cpp/CMakeLists.txt
          workflowPreset: ${{ steps.preset-name.outputs.name }}

      - name: Restore aoc-main uv project
        uses: ./.github/actions/uv-project-setup
        with:
          directory: aoc-main

      - name: Run all solutions
        env:
          AOC_CPP_SKIP_PREPARE: "1"
          AOC_CPP_WORKFLOW_PRESET: ${{ steps.preset-name.outputs.name }}
        run: mise run aoc:all -- --solver cpp -vv

      - name: Finalize cmake project
        uses: ./.github/actions/cmake-project-finalize
        with:
          conan-cache-key-prefix: conan-${{ steps.preset-name.outputs.name }}
          conan-cache-matched-key: ${{ steps.setup-cmake-project.outputs.conan-cache-matched-key }}
