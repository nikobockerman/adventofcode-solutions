name: mise project setup
description: Setup mise and tools for project directory
inputs:
  cache-mode:
    default: use
    description: "Mode of operation regarding cache: 'prepare' or 'use'"
    required: false
  directory:
    description: Directory where mise and tools will be used in. Must be set to "" if `cache-mode` is "prepare".
    required: true

runs:
  using: composite
  steps:
    - id: init

      env:
        CACHE_MODE: ${{ inputs.cache-mode }}
        DIRECTORY: ${{ inputs.directory }}
        # renovate: datasource=github-releases depName=jdx/mise
        MISE_VERSION: v2026.2.13
      run: |
        # Initialize mise-project-setup action
        "${GITHUB_ACTION_PATH}/init.sh"
      shell: bash

    - id: check-cache-match
      if: inputs.cache-mode == 'prepare'
      name: Mise cache check for exact match
      uses: actions/cache/restore@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
      with:
        key: mise-${{ runner.os }}-${{ steps.init.outputs.mise-version }}-${{ hashFiles('mise.toml') }}-${{ hashFiles('aoc-main/mise.toml') }}-${{ hashFiles('solvers/*/mise.toml') }}
        lookup-only: true
        path: ${{ steps.init.outputs.cache-paths }}

    - id: cache-check
      env:
        CACHE_MODE: ${{ inputs.cache-mode }}
        EXACT_MATCH: ${{ steps.check-cache-match.outputs.cache-hit }}
      run: |
        # Check if cache mode is 'prepare' and exact match is true
        match=false
        if [[ "${CACHE_MODE}" == "prepare" && "${EXACT_MATCH}" == "true" ]]; then
          echo "Exact match found in prepare mode. Skipping the rest of the action"
          match=true
        fi
        echo "::group::Outputs from cache-check"
        echo "match=${match}" | tee -a "${GITHUB_OUTPUT}"
        echo "::endgroup::"
      shell: bash

    - id: cache-restore
      if: steps.cache-check.outputs.match != 'true'
      name: Mise cache restore
      uses: actions/cache/restore@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
      with:
        key: mise-${{ runner.os }}-${{ steps.init.outputs.mise-version }}-${{ hashFiles('mise.toml') }}-${{ hashFiles('aoc-main/mise.toml') }}-${{ hashFiles('solvers/*/mise.toml') }}
        path: ${{ steps.init.outputs.cache-paths }}
        restore-keys: |
          mise-${{ runner.os }}-${{ steps.init.outputs.mise-version }}-${{ hashFiles('mise.toml') }}-${{ hashFiles('aoc-main/mise.toml') }}-
          mise-${{ runner.os }}-${{ steps.init.outputs.mise-version }}-${{ hashFiles('mise.toml') }}-
          mise-${{ runner.os }}-${{ steps.init.outputs.mise-version }}-
          mise-${{ runner.os }}-

    - if: steps.cache-check.outputs.match != 'true'
      name: Install mise
      uses: jdx/mise-action@6d1e696aa24c1aa1bcc1adea0212707c71ab78a8 # v3.6.1

      env:
        TEMP: ${{ runner.temp }}
      with:
        cache: false
        cache_save: false
        install: false
        version: ${{ steps.init.outputs.mise-version }}
        working_directory: ${{ inputs.directory }}

    - if: steps.cache-check.outputs.match != 'true' && steps.cache-restore.outputs.cache-hit != 'true'

      env:
        DIRECTORIES: ${{ steps.init.outputs.mise-install-directories }}

        # Mise settings for CI
        ## Only use precompiled python binaries
        MISE_PYTHON_COMPILE: false
      run: |
        # Install mise tools
        "${GITHUB_ACTION_PATH}/install-tools.sh"
      shell: bash

    - if: inputs.cache-mode == 'prepare' && steps.cache-check.outputs.match != 'true' && steps.cache-restore.outputs.cache-hit != 'true'
      name: Save cache
      uses: actions/cache/save@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
      with:
        key: ${{ steps.cache-restore.outputs.cache-primary-key }}
        path: ${{ steps.init.outputs.cache-paths }}

    - if: steps.cache-check.outputs.match != 'true'
      env:
        DIRECTORIES: ${{ steps.init.outputs.mise-install-directories }}
      run: |
        # Ensure tools are installed properly
        set -euo pipefail
        err=false
        for dir in ${DIRECTORIES}; do
          echo "::group::Ensure dependencies: ${dir}"
          pushd "${dir}"
          mise ls --current
          count=$(mise ls --current --missing --no-header | wc -l)
          if [[ ${count} -gt 0 ]]; then
            echo "::error::Count of missing tools: ${count}"
            err=true
          else
            echo "Result of check: no missing tools"
          fi
          popd
          echo "::endgroup::"
        done

        if [[ "${err}" == true ]]; then
          exit 1
        fi
      shell: bash

    - if: steps.cache-check.outputs.match != 'true'
      run: |
        # Set final changes for rest of workflow

        echo "::group::Environment changes for rest of workflow"
        {
          echo "MISE_PREPARE_AUTO=false"
          echo "UV_PYTHON_DOWNLOADS=never"
        } | tee -a "${GITHUB_ENV}"
        echo "::endgroup::"
      shell: bash
